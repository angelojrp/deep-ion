---
plan_id: PLAN-20260224-001
title: "Implementação do DOM-02 Requirements Agent"
classification: T1
created_at: "2026-02-24T00:00:00Z"
created_by: "Arquiteto Corporativo"
status: APROVADO
approval:
  approved_by: "Arquiteto Corporativo"
  approved_at: "2026-02-24T00:00:00Z"
  rejection_reason: ""
linked_issue: ""
linked_pr: ""
---

<!--
  REGRA DE EXECUÇÃO:
  Nenhum agente ou workflow pode iniciar tarefas deste plano enquanto:
    status != "APROVADO"  OU  approval.approved_by == ""
  Em caso de violação → workflow aborta e comenta na Issue vinculada.
-->

## Plano de Execução — Implementação do DOM-02 Requirements Agent
**Classificação de Impacto:** T1

---

### Contexto

O DOM-02 Requirements Agent é o segundo agente do pipeline da Fábrica de Software
Autônoma. Sua função é transformar uma Issue GitHub aprovada no Gate 1 em artefatos
de requisitos formais: BusinessAnalysisRecord (BAR), Use Cases canônicos com Gherkin
e Matriz de Rastreabilidade.

O agente é composto por três skills executadas como processos isolados:

- **SKILL-REQ-00** — Duplicate & Conflict Detector (≤ 60s, auto)
- **SKILL-REQ-01** — Business Analyst Agent → BAR → Checkpoint A
- **SKILL-REQ-02** — Use Case Modeler Agent → UCs + Matriz → Gate 2

A especificação completa está em `agents_specs/DOM-02_SPEC.md`.

A estrutura de diretórios física (`.github/requirements/prompts/` e
`.github/workflows/`) foi criada junto com este plano. As tarefas abaixo
implementam os arquivos dentro desses diretórios.

---

### Dependências de Artefatos

```
rn_catalog.py ──────────────┐
                             ├──► skill_req_00.py ──► requirements-trigger.yml
uc_repository.py ───────────┘
rn_catalog.py ──────────────┬──► skill_req_01.py ──┐
prompts/bar_generation.md ──┘                       ├──► checkpoint-automation.yml
rn_catalog.py ──────────────┬──► skill_req_02.py ──┘
prompts/uc_generation.md ───┘
```

---

### Tarefas

| #  | Tarefa | Agente | Artefato de saída | Depende de | Paralelo com | Modelo sugerido | Justificativa do modelo |
|----|--------|--------|-------------------|------------|--------------|-----------------|-------------------------|
| 1  | Implementar `rn_catalog.py` — catálogo RN-01..RN-07 com FEs determinísticos e função de lookup `get_rn_by_module(module, action) → [RN]` e `get_fe_for_rn(rn_id) → FE` | DOM-04 | `.github/requirements/rn_catalog.py` | — | #2, #3, #4 | `GPT-4o` | Lógica totalmente determinística, hardcoded, sem raciocínio multi-etapa. Bem especificada na DOM-02_SPEC.md. |
| 2  | Implementar `uc_repository.py` — lê UCs existentes nas Issues GitHub (busca por prefixo `## UC-`) e retorna lista estruturada para alimentar a verificação V1 do REQ-00 | DOM-04 | `.github/requirements/uc_repository.py` | — | #1, #3, #4 | `GPT-4o` | Integração simples com GitHub REST API; sem lógica de negócio complexa. |
| 3  | Criar `prompts/bar_generation.md` — prompt estruturado para o SKILL-REQ-01 gerar o BAR; deve cobrir as seções A1–A7, incluir o catálogo RN inline, instruir sobre `confidence_score`, e proibir explicitamente inferência em `Ambiguidades não resolvidas` | DOM-04 | `.github/requirements/prompts/bar_generation.md` | — | #1, #2, #4 | `Claude Opus 4.6` | Engenharia de prompt crítica: determina a qualidade de todo o artefato BAR. Requer raciocínio sobre como guiar o LLM a não inferir ambiguidades (condição B4). |
| 4  | Criar `prompts/uc_generation.md` — prompt estruturado para o SKILL-REQ-02 gerar UCs canônicos; deve reforçar schema fixo, geração determinística de FEs por RN via tabela RN→FE, e Gherkin obrigatório por cenário (incluindo um cenário por FE) | DOM-04 | `.github/requirements/prompts/uc_generation.md` | — | #1, #2, #3 | `Claude Opus 4.6` | Mesma justificativa de #3: qualidade do prompt determina conformidade dos UCs com o schema fixo da spec. |
| 5  | Implementar `skill_req_00.py` — Duplicate & Conflict Detector; verificações V1–V5; bloqueio automático em B1/B2; publica DuplicateReport como comentário na Issue; aplica labels `req/duplicatas-verificadas` ou `blocked/rn-violation`; grava `DecisionRecord` | DOM-04 | `.github/requirements/skill_req_00.py` | #1, #2 | — | `GPT-5.1-Codex` | Múltiplos fluxos condicionais (V1–V5), chamada a GitHub API, similaridade semântica para V1, lógica de bloqueio e Audit Ledger. Alta complexidade de código. |
| 6  | Implementar `skill_req_01.py` — Business Analyst Agent; chama LLM com o prompt BAR; verifica `confidence_score`; bloqueia Checkpoint A em ambiguidades críticas (B4) ou LGPD (B5); publica BAR na Issue; grava `DecisionRecord` com `approval_weight: 0.4` | DOM-04 | `.github/requirements/skill_req_01.py` | #1, #3 | #7 | `GPT-5.1-Codex` | Orquestração completa: parse do DecisionRecord anterior, invocação do LLM via AI Provider abstrato, publicação estruturada e lógica de bloqueio condicional. |
| 7  | Implementar `skill_req_02.py` — Use Case Modeler Agent; lê **apenas** o BAR aprovado (nunca a issue original); gera 1..N UCs canônicos com Gherkin + Matriz de Rastreabilidade; valida FEs determinísticos cruzando com `rn_catalog`; grava `DecisionRecord` | DOM-04 | `.github/requirements/skill_req_02.py` | #1, #4 | #6 | `GPT-5.1-Codex` | Mesma complexidade de #6, acrescida da validação determinística de FEs e geração da Matriz de Rastreabilidade. |
| 8  | Criar `requirements-trigger.yml` — GitHub Actions; trigger: `issue_comment.created` filtrado por `/gate1-approve`; executa REQ-00; aguarda label `req/duplicatas-verificadas`; executa REQ-01; gerencia state machine de labels | DOM-04 | `.github/workflows/requirements-trigger.yml` | #5 | #9 | `GPT-4o` | YAML padrão de GitHub Actions com steps sequenciais e condicionais de label. Escopo bem delimitado. |
| 9  | Criar `checkpoint-automation.yml` — GitHub Actions; trigger: `issue_comment.created` filtrado por `/ba-approve`, `/ba-reject`, `/ba-revise`; aplica label `req/bar-aprovado` somente em `/ba-approve`; executa REQ-02 somente em `/ba-approve`; gerencia labels de gate | DOM-04 | `.github/workflows/checkpoint-automation.yml` | #6, #7 | #8 | `GPT-4o` | Lógica de branching por comando mapeável diretamente em `if` de steps. Sem complexidade de negócio. |

---

### Riscos e Condições de Bloqueio

- **R1 — Isolamento de skills violado:** se `skill_req_02.py` ler a issue original em vez do BAR aprovado, a spec é violada. A revisão humana do Gate 2 deve verificar esse comportamento explicitamente antes de `status = APROVADO`.
- **R2 — Inferência silenciosa de ambiguidades:** o prompt de `bar_generation.md` (tarefa #3) é crítico. Se mal elaborado, o LLM pode preencher `Ambiguidades não resolvidas` com suposições, violando B4. O gate de "Revisão de Prompt" é obrigatório antes de #6 iniciar.
- **R3 — Latência da verificação V1:** estratégia definida como Opção B (TF-IDF / keywords). Interface isolada em `uc_repository.py` deve permitir substituição por embedding (Opção A) em Fase 1 sem alteração das skills.
- **R4 — AI Provider abstrato ausente:** as skills #6 e #7 dependem da camada de abstração de AI Provider. Se não existir no repositório, deve ser criada como pré-requisito. Verificar antes de iniciar #6 e #7.
- **R5 — Schema do DecisionRecord não centralizado:** cada skill grava seu próprio `DecisionRecord`. Sem um módulo `audit_ledger.py` compartilhado, há risco de divergência de schema entre skills. Considerar criar este módulo como tarefa implícita pré-#5.

---

### Gates Necessários

| Gate | Responsável | Condição de avanço |
|------|-------------|-------------------|
| **Aprovação deste plano** | Tech Lead | Preencher `approval.approved_by` e `approval.approved_at`; alterar `status: APROVADO` |
| **Revisão de Prompt** (entre #4 e #6) | Tech Lead + Analista | `prompts/bar_generation.md` e `prompts/uc_generation.md` revisados manualmente |
| **Smoke Test REQ-00** (após #5) | QA | `python .github/requirements/skill_req_00.py --issue <test-issue>` em staging, issue T0 sem RNs |
| **Smoke Test E2E** (após #9) | Tech Lead | Pipeline completo `/gate1-approve` → BAR publicado → `/ba-approve` → UCs publicados; issue T0 |

---

### Decisão Registrada — Estratégia de Similaridade Semântica (V1)

**Decisão:** Opção B — Heurística TF-IDF / keywords  
**Decidido por:** Arquiteto Corporativo  
**Data:** 2026-02-24

| Critério | Opção A (Embedding) | ✅ Opção B (TF-IDF / keywords) |
|---|---|---|
| Precisão | Alta (semântica real) | Média (lexical) |
| Latência | ~3–5s por UC comparado | < 1s total |
| Custo | Tokens por comparação | Zero |
| Risco de timeout | Alto com muitos UCs | Baixo |
| Fase 0 adequado? | Não | **Sim** |

**Requisito de implementação:** a lógica de similaridade deve ficar isolada em `uc_repository.py` (método `find_similar_ucs(text) → [UC]`) com interface estável, permitindo substituição por Opção A em Fase 1 sem nenhuma alteração nas skills.

---

### Histórico de Revisões

| Data | Autor | Alteração |
|------|-------|-----------|
| 2026-02-24 | Arquiteto Corporativo | Criação do plano |
| 2026-02-24 | Arquiteto Corporativo | Decisão V1 registrada: Opção B (TF-IDF) adotada para Fase 0; gate removido |
| 2026-02-24 | Arquiteto Corporativo | Plano aprovado — tarefas liberadas para execução |
